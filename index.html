<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Air War Game - WWII Strategy</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            width: 100vw;
            height: 100vh;
            overflow: hidden;
            background: #0a0a0a;
            font-family: 'Consolas', 'Monaco', 'Lucida Console', monospace;
            color: #c0c0c0;
            font-size: 11px;
        }

        /* Launch Screen */
        #launch-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #0a0a0a;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            overflow-y: auto;
            padding: 20px;
        }

        #launch-screen h1 {
            font-size: 24px;
            margin-bottom: 5px;
            color: #00ff00;
            font-weight: normal;
        }

        #launch-screen h2 {
            font-size: 12px;
            margin-bottom: 20px;
            color: #808080;
        }

        .launch-section {
            background: #111;
            border: 1px solid #333;
            padding: 15px;
            margin: 8px 0;
            width: 500px;
            max-width: 90%;
        }

        .launch-section h3 {
            margin-bottom: 10px;
            color: #00ff00;
            font-size: 11px;
            text-transform: uppercase;
        }

        .input-group {
            margin: 6px 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .input-group label {
            flex: 1;
            color: #808080;
        }

        .input-group input, .input-group select {
            flex: 1;
            padding: 4px 6px;
            border: 1px solid #333;
            background: #0a0a0a;
            color: #c0c0c0;
            font-family: inherit;
            font-size: 11px;
        }

        button {
            padding: 4px 8px;
            font-size: 10px;
            border: 1px solid #444;
            cursor: pointer;
            background: #1a1a1a;
            color: #c0c0c0;
            font-family: inherit;
            text-transform: uppercase;
        }

        button:hover {
            background: #2a2a2a;
            border-color: #00ff00;
            color: #00ff00;
        }

        #start-game-btn {
            margin-top: 15px;
            padding: 8px 20px;
            font-size: 11px;
        }

        .country-list {
            max-height: 200px;
            overflow-y: auto;
            background: #0a0a0a;
            padding: 5px;
            border: 1px solid #333;
        }

        .country-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 2px;
            margin: 1px 0;
        }

        .country-item label {
            flex: 1;
            font-size: 10px;
        }

        .country-item select {
            flex: 0 0 100px;
            font-size: 10px;
        }

        /* Game UI */
        #game-ui {
            display: none;
            width: 100%;
            height: 100%;
        }

        #globe-container {
            position: absolute;
            width: 100%;
            height: 100%;
            background: #E0DCD7;
        }

        svg {
            display: block;
        }

        .graticule {
            fill: none;
            stroke: #d0ccc7;
            stroke-width: 0.3px;
            stroke-dasharray: 2,2;
        }

        .land {
            fill: #B8B0A7;
            stroke: none;
        }

        .boundary {
            fill: none;
            stroke: #605C58;
            stroke-width: 3px;
        }

        .globe-sphere {
            fill: #E0DCD7;
            stroke: #a0a0a0;
            stroke-width: 1px;
        }

        .foreground {
            fill: none;
            stroke: transparent;
            stroke-width: 1px;
            pointer-events: all;
            cursor: grab;
        }

        .foreground:active {
            cursor: grabbing;
        }

        /* Left Panel */
        #left-panel {
            position: absolute;
            left: 0;
            top: 0;
            width: 260px;
            height: 100%;
            background: rgba(10, 10, 10, 0.95);
            padding: 10px;
            overflow-y: auto;
            z-index: 100;
            border-right: 1px solid #333;
        }

        #left-panel h2 {
            color: #00ff00;
            margin-bottom: 10px;
            font-size: 12px;
            text-transform: uppercase;
            font-weight: normal;
        }

        #left-panel h3 {
            color: #808080;
            margin: 8px 0 5px 0;
            font-size: 10px;
            text-transform: uppercase;
        }

        #left-panel h4 {
            color: #606060;
            font-size: 9px;
            text-transform: uppercase;
            font-weight: normal;
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            margin: 2px 0;
            padding: 2px 4px;
            font-size: 10px;
        }

        .stat-label {
            color: #606060;
        }

        .stat-value {
            color: #c0c0c0;
        }

        .team-section {
            margin: 8px 0;
            padding: 8px;
            background: #111;
            border: 1px solid #333;
        }

        .controls-section {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #333;
        }

        .button-group {
            display: flex;
            gap: 4px;
            margin: 5px 0;
        }

        .button-group button {
            flex: 1;
            padding: 3px 4px;
            font-size: 9px;
        }

        /* City Popup */
        #city-popup {
            display: none;
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            width: 280px;
            background: rgba(10, 10, 10, 0.95);
            border: 1px solid #333;
            padding: 10px;
            z-index: 200;
        }

        #city-popup h2 {
            color: #00ff00;
            margin-bottom: 8px;
            font-size: 11px;
            font-weight: normal;
        }

        #city-popup .popup-section {
            margin: 8px 0;
        }

        #close-popup-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            padding: 2px 6px;
            font-size: 9px;
        }

        /* Top Bar */
        #top-bar {
            position: absolute;
            top: 0;
            left: 260px;
            right: 0;
            height: 30px;
            background: rgba(10, 10, 10, 0.9);
            display: flex;
            align-items: center;
            padding: 0 10px;
            z-index: 100;
            border-bottom: 1px solid #333;
        }

        #top-bar .info-item {
            margin: 0 15px;
            color: #606060;
            font-size: 10px;
        }

        #top-bar .info-value {
            color: #00ff00;
        }

        /* Responsive */
        @media (max-width: 800px) {
            #left-panel {
                width: 200px;
            }
            .launch-section {
                width: 100%;
            }
        }

        /* Warning indicator */
        .warning-indicator {
            color: #ff0000;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <!-- Launch Screen -->
    <div id="launch-screen">
        <h1>AIR WAR</h1>
        <h2>Strategic Air Command Simulation</h2>

        <div class="launch-section">
            <h3>Game Settings</h3>
            <div class="input-group">
                <label>Random Seed:</label>
                <input type="number" id="seed-input" placeholder="Leave blank for random">
            </div>
            <div class="input-group">
                <label>Team 1 Color:</label>
                <input type="color" id="team1-color" value="#cc0000">
                <span id="team1-name" style="margin-left: 10px; font-weight: bold;">Red</span>
            </div>
            <div class="input-group">
                <label>Team 2 Color:</label>
                <input type="color" id="team2-color" value="#0066cc">
                <span id="team2-name" style="margin-left: 10px; font-weight: bold;">Blue</span>
            </div>
            <div class="input-group">
                <label>You play as:</label>
                <select id="player-team-select">
                    <option value="team1">Team 1</option>
                    <option value="team2">Team 2</option>
                </select>
            </div>
        </div>

        <div class="launch-section">
            <div id="country-allocation">
                <h3>Loading countries...</h3>
            </div>
        </div>

        <button id="start-game-btn">Start Game</button>
    </div>

    <!-- Game UI -->
    <div id="game-ui">
        <!-- Globe Container -->
        <div id="globe-container"></div>

        <!-- Top Bar -->
        <div id="top-bar">
            <div class="info-item">
                Time: <span class="info-value" id="game-time">0:00</span>
            </div>
            <div class="info-item">
                Seed: <span class="info-value" id="seed-display">-</span>
            </div>
        </div>

        <!-- Left Panel -->
        <div id="left-panel">
            <h2>Air War Command</h2>

            <!-- Player Team Stats -->
            <div class="team-section" id="player-team-section">
                <h3 id="player-team-header">Your Team</h3>
                <div class="stat-row">
                    <span class="stat-label">Production:</span>
                    <span class="stat-value" id="player-production">0M/min</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Cities:</span>
                    <span class="stat-value" id="player-cities">0</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Aircraft:</span>
                    <span class="stat-value" id="player-aircraft">0F / 0B</span>
                </div>

                <!-- Production Allocation -->
                <h4 style="margin: 10px 0 5px 0; color: #aaa;">Production Allocation</h4>
                <div id="production-allocation-container">
                    <!-- Dynamic template allocations will be inserted here -->
                </div>
            </div>

            <!-- AI Team Stats -->
            <div class="team-section" id="ai-team-section">
                <h3 id="ai-team-header">Enemy (AI)</h3>
                <div class="stat-row">
                    <span class="stat-label">Production:</span>
                    <span class="stat-value" id="ai-production">0M/min</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Cities:</span>
                    <span class="stat-value" id="ai-cities">0</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Aircraft:</span>
                    <span class="stat-value" id="ai-aircraft">0F / 0B</span>
                </div>
            </div>

            <!-- Aircraft Design -->
            <div class="controls-section">
                <h3>Design Aircraft</h3>
                <div class="input-group" style="margin: 5px 0;">
                    <label style="font-size: 12px;">Type:</label>
                    <select id="design-type" style="padding: 4px;">
                        <option value="fighter">Fighter</option>
                        <option value="bomber">Bomber</option>
                    </select>
                </div>
                <div class="input-group" style="margin: 5px 0;">
                    <label style="font-size: 12px;">Cost (M):</label>
                    <input type="number" id="design-cost" value="3" min="1" max="100" style="width: 60px; padding: 4px;">
                </div>
                <div id="design-points" style="font-size: 11px; color: #f39c12; margin: 5px 0;">
                    Points available: 8
                </div>
                <div class="input-group" style="margin: 5px 0;">
                    <label style="font-size: 12px;">Range:</label>
                    <input type="number" id="design-range" value="30" min="10" max="100" style="width: 50px; padding: 4px;">
                </div>
                <div class="input-group" style="margin: 5px 0;">
                    <label style="font-size: 12px;">Offense:</label>
                    <input type="number" id="design-offense" value="30" min="1" max="100" style="width: 50px; padding: 4px;">
                </div>
                <div class="input-group" style="margin: 5px 0;">
                    <label style="font-size: 12px;">Defense:</label>
                    <input type="number" id="design-defense" value="20" min="1" max="100" style="width: 50px; padding: 4px;">
                </div>
                <div class="input-group" style="margin: 5px 0;">
                    <label style="font-size: 12px;">Name:</label>
                    <input type="text" id="design-name" value="Custom" style="width: 80px; padding: 4px;">
                </div>
                <button id="create-design-btn" style="width: 100%; margin-top: 5px; font-size: 12px;">Create Design</button>
            </div>

            <!-- Game Controls -->
            <div class="controls-section">
                <h3>Game Controls</h3>
                <div class="button-group">
                    <button id="pause-btn">Pause</button>
                </div>
                <div class="button-group">
                    <button id="speed-1x">1x</button>
                    <button id="speed-2x">2x</button>
                    <button id="speed-4x">4x</button>
                </div>
                <div class="button-group">
                    <button id="save-btn">Save</button>
                    <button id="load-btn">Load</button>
                </div>
            </div>
        </div>

        <!-- City Popup -->
        <div id="city-popup">
            <button id="close-popup-btn">âœ•</button>
            <h2 id="popup-city-name">City Name</h2>

            <div class="popup-section">
                <div class="stat-row">
                    <span class="stat-label">Country:</span>
                    <span class="stat-value" id="popup-city-country">-</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Owner:</span>
                    <span class="stat-value" id="popup-city-owner">-</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">HP:</span>
                    <span class="stat-value" id="popup-city-hp">-</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Production:</span>
                    <span class="stat-value" id="popup-city-production">-</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Aircraft:</span>
                    <span class="stat-value" id="popup-aircraft-count">-</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Target:</span>
                    <span class="stat-value" id="popup-target">-</span>
                </div>
            </div>

            <div id="popup-airbase-controls" class="popup-section">
                <h3>Airbase Controls</h3>
                <div id="popup-warning" class="warning-indicator" style="display: none; margin: 5px 0;"></div>

                <!-- Fighter assignment slider -->
                <div id="fighter-assignment-control" style="margin: 8px 0; display: none;">
                    <div style="display: flex; justify-content: space-between; font-size: 10px;">
                        <span>Defend</span>
                        <span id="escort-pct">50%</span>
                        <span>Escort</span>
                    </div>
                    <input type="range" id="escort-allocation" min="0" max="100" value="50" style="width: 100%;">
                </div>

                <button id="build-airbase-btn" style="width: 100%; margin: 3px 0;">Build Airbase (50M)</button>
                <button id="set-delivery-btn" style="width: 100%; margin: 3px 0;">Set Delivery</button>
                <button id="set-bomber-target-btn" style="width: 100%; margin: 3px 0;">Set Target</button>
                <button id="rebase-btn" style="width: 100%; margin: 3px 0;">Re-base Aircraft</button>
            </div>
        </div>

        <!-- Combat Log -->
        <div id="combat-log" style="position: absolute; bottom: 10px; left: 270px; width: 300px; max-height: 150px; background: rgba(10, 10, 10, 0.95); border: 1px solid #333; padding: 8px; overflow-y: auto; z-index: 100; font-size: 9px;">
            <h4 style="margin: 0 0 5px 0; color: #00ff00; font-size: 10px;">Combat Log</h4>
            <div id="combat-log-entries"></div>
        </div>

        <!-- Bases Info Panel -->
        <div id="bases-info-panel" style="position: absolute; right: 0; top: 30px; width: 200px; height: calc(100% - 30px); background: rgba(10, 10, 10, 0.95); border-left: 1px solid #333; padding: 8px; overflow-y: auto; z-index: 100; font-size: 9px;">
            <h4 style="margin: 0 0 8px 0; color: #00ff00; font-size: 10px;">Airbases</h4>
            <div id="bases-list"></div>
        </div>
    </div>

    <!-- D3 Libraries -->
    <script src="https://d3js.org/d3.v3.min.js"></script>
    <script src="https://d3js.org/d3.geo.projection.v0.min.js"></script>
    <script src="https://d3js.org/topojson.v1.min.js"></script>

    <!-- Versor Library for Quaternion Rotation -->
    <script>
        (function() {
            var acos = Math.acos, asin = Math.asin, atan2 = Math.atan2,
                cos = Math.cos, max = Math.max, min = Math.min,
                PI = Math.PI, sin = Math.sin, sqrt = Math.sqrt,
                radians = PI / 180, degrees = 180 / PI;

            function versor(e) {
                var l = e[0] / 2 * radians, p = e[1] / 2 * radians, g = e[2] / 2 * radians,
                    sl = sin(l), cl = cos(l), sp = sin(p), cp = cos(p),
                    sg = sin(g), cg = cos(g);
                return [
                    cl * cp * cg + sl * sp * sg,
                    sl * cp * cg - cl * sp * sg,
                    cl * sp * cg + sl * cp * sg,
                    cl * cp * sg - sl * sp * cg
                ];
            }

            versor.rotation = function(q) {
                return [
                    atan2(2 * (q[0] * q[1] + q[2] * q[3]), 1 - 2 * (q[1] * q[1] + q[2] * q[2])) * degrees,
                    asin(max(-1, min(1, 2 * (q[0] * q[2] - q[3] * q[1])))) * degrees,
                    atan2(2 * (q[0] * q[3] + q[1] * q[2]), 1 - 2 * (q[2] * q[2] + q[3] * q[3])) * degrees
                ];
            };

            versor.cartesian = function(e) {
                var l = e[0] * radians, p = e[1] * radians, cp = cos(p);
                return [cp * cos(l), cp * sin(l), sin(p)];
            };

            versor.delta = function(v0, v1) {
                var w = cross(v0, v1), l = sqrt(dot(w, w));
                if (!l) return [1, 0, 0, 0];
                var t = acos(max(-1, min(1, dot(v0, v1)))) / 2, s = sin(t);
                return [cos(t), w[2] / l * s, -w[1] / l * s, w[0] / l * s];
            };

            versor.multiply = function(a, b) {
                return [
                    a[0] * b[0] - a[1] * b[1] - a[2] * b[2] - a[3] * b[3],
                    a[0] * b[1] + a[1] * b[0] + a[2] * b[3] - a[3] * b[2],
                    a[0] * b[2] - a[1] * b[3] + a[2] * b[0] + a[3] * b[1],
                    a[0] * b[3] + a[1] * b[2] - a[2] * b[1] + a[3] * b[0]
                ];
            };

            function cross(v0, v1) {
                return [v0[1] * v1[2] - v0[2] * v1[1], v0[2] * v1[0] - v0[0] * v1[2], v0[0] * v1[1] - v0[1] * v1[0]];
            }

            function dot(v0, v1) {
                return v0[0] * v1[0] + v0[1] * v1[1] + v0[2] * v1[2];
            }

            window.versor = versor;
        })();
    </script>

    <!-- Game Modules -->
    <script src="constants.js"></script>
    <script src="rng.js"></script>
    <script src="map-utils.js"></script>
    <script src="data-loader.js"></script>
    <script src="game-state.js"></script>
    <script src="production.js"></script>
    <script src="combat.js"></script>
    <script src="ai-bot.js"></script>
    <script src="renderer.js"></script>
    <script src="main-loop.js"></script>
    <script src="save-load.js"></script>
    <script src="ui-controls.js"></script>

    <!-- Main Application Script -->
    <script>
        // Global variables
        let projection, path, svg;

        // Initialize on page load
        window.addEventListener('load', async function() {
            try {
                // Setup globe
                setupGlobe();

                // Load game data
                const seed = Math.floor(Math.random() * 1000000);
                const tempRng = new RNG(seed);
                const gameData = await DataLoader.loadGameData(tempRng);

                // Initialize game state
                GameState.initialize(seed, gameData);

                // Initialize UI
                UIControls.initialize();

                console.log('Game initialized successfully');
                console.log(`Loaded ${GameState.cities.length} cities from ${GameState.countries.size} countries`);

            } catch (error) {
                console.error('Failed to initialize game:', error);
                alert('Failed to load game data. Please check console for errors.');
            }
        });

        function setupGlobe() {
            const width = window.innerWidth;
            const height = window.innerHeight;
            const radius = Math.min(width, height) * 0.4;

            projection = d3.geo.orthographic()
                .scale(radius)
                .translate([width / 2, height / 2])
                .clipAngle(90)
                .rotate([0, -20, 0]);

            path = d3.geo.path().projection(projection);

            const graticule = d3.geo.graticule();

            svg = d3.select("#globe-container").append("svg")
                .attr("width", width)
                .attr("height", height);

            // Globe sphere
            svg.append("path")
                .datum({type: "Sphere"})
                .attr("class", "globe-sphere")
                .attr("d", path);

            // Graticule
            svg.append("path")
                .datum(graticule)
                .attr("class", "graticule")
                .attr("d", path);

            // Land and boundaries groups
            const landGroup = svg.append("g").attr("class", "land-group");
            const boundaryGroup = svg.append("g").attr("class", "boundary-group");

            // Load world topology
            d3.json("https://cdn.jsdelivr.net/npm/world-atlas@1/world/110m.json", function(error, world) {
                if (error) {
                    console.error("Error loading world data:", error);
                    return;
                }

                const countries = topojson.feature(world, world.objects.countries);
                const borders = topojson.mesh(world, world.objects.countries, function(a, b) { return a !== b; });

                landGroup.selectAll(".land")
                    .data(countries.features)
                    .enter().append("path")
                    .attr("class", "land")
                    .attr("d", path);

                boundaryGroup.append("path")
                    .datum(borders)
                    .attr("class", "boundary")
                    .attr("d", path);
            });

            // Foreground for interaction
            const foreground = svg.append("path")
                .datum({type: "Sphere"})
                .attr("class", "foreground")
                .attr("d", path);

            // Drag behavior with versor
            let v0, r0, q0;

            const drag = d3.behavior.drag()
                .on("dragstart", function() {
                    const p = d3.mouse(this);
                    const inverted = projection.invert(p);
                    if (!inverted) return;
                    v0 = versor.cartesian(inverted);
                    r0 = projection.rotate();
                    q0 = versor(r0);
                })
                .on("drag", function() {
                    if (!v0) return;
                    const p = d3.mouse(this);
                    const inverted = projection.invert(p);
                    if (!inverted) return;

                    const v1 = versor.cartesian(inverted);
                    const delta = versor.delta(v0, v1);
                    let q1 = versor.multiply(q0, delta);
                    let r1 = versor.rotation(q1);

                    r1[2] = 0; // Lock gamma to 0
                    q0 = versor(r1);
                    v0 = v1;

                    projection.rotate(r1);
                    svg.selectAll("path").attr("d", path);

                    // Update renderer if game is running
                    if (Renderer.svg) {
                        Renderer.render();
                    }
                });

            foreground.call(drag);

            // Zoom with scroll wheel
            const initialScale = projection.scale();
            const minScale = initialScale * 0.5;
            const maxScale = initialScale * 5;

            d3.select("#globe-container").on("wheel", function() {
                d3.event.preventDefault();
                const delta = d3.event.deltaY;
                let scale = projection.scale();

                if (delta < 0) {
                    scale *= 1.1; // Zoom in
                } else {
                    scale /= 1.1; // Zoom out
                }

                scale = Math.max(minScale, Math.min(maxScale, scale));
                projection.scale(scale);
                svg.selectAll("path").attr("d", path);

                if (Renderer.svg) {
                    Renderer.render();
                }
            });

            // Middle-click to reset zoom
            d3.select("#globe-container").on("mousedown", function() {
                if (d3.event.button === 1) { // Middle mouse button
                    d3.event.preventDefault();
                    projection.scale(initialScale);
                    svg.selectAll("path").attr("d", path);

                    if (Renderer.svg) {
                        Renderer.render();
                    }
                }
            });

            // Prevent context menu on middle-click
            d3.select("#globe-container").on("contextmenu", function() {
                if (d3.event.button === 1) {
                    d3.event.preventDefault();
                }
            });

            // Initialize renderer
            Renderer.initialize(svg, projection, path);
        }

        // Center globe on a city
        function centerOnCity(city) {
            const rotation = projection.rotate();
            projection.rotate([-city.lon, -city.lat, 0]);
            svg.selectAll("path").attr("d", path);
            if (Renderer.svg) {
                Renderer.render();
            }
        }

        // Handle window resize
        window.addEventListener('resize', function() {
            location.reload();
        });
    </script>
</body>
</html>
